name: Helm Chart Publisher

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true
        type: string
permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  export-registry:
    runs-on: ubuntu-latest
    outputs:
      registry_repo: ${{ steps.export.outputs.registry_repo }}
      release_tag: ${{ steps.export.outputs.release_tag }}
      release_version: ${{ steps.export.outputs.release_version }}
    steps:
      - id: export
        run: |
          set -euo pipefail

          RELEASE_TAG="${GITHUB_REF#refs/tags/}"
          if [[ ! "${RELEASE_TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: invalid release tag '${RELEASE_TAG}'. Expected format: vX.Y.Z"
            exit 1
          fi

          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "registry_repo=${{ env.REGISTRY }}/${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "release_version=${RELEASE_TAG#v}" >> $GITHUB_OUTPUT

  publish-github-pages:
    needs: export-registry
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          submodules: true
          fetch-depth: 0
      - name: Publish Helm chart to GitHub Pages
        uses: stefanprodan/helm-gh-pages@v1.7.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          charts_dir: charts
          target_dir: charts
          linting: on

  publish-oci:
    needs: export-registry
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and push Helm charts to GHCR via Makefile
        run: |
          set -euo pipefail

          RELEASE_VERSION="${{ needs.export-registry.outputs.release_version }}"

          OCI_REGISTRY="${{ needs.export-registry.outputs.registry_repo }}/charts"
          make helm-push REGISTRY="${OCI_REGISTRY}" TAG="${RELEASE_VERSION}"

      - name: Verify chart appVersion matches release tag
        run: |
          set -euo pipefail

          RELEASE_VERSION="${{ needs.export-registry.outputs.release_version }}"
          CHART_VERSION="${RELEASE_VERSION}"
          EXPECTED_APP_VERSION="${RELEASE_VERSION}"

          rm -rf .helm-verify
          mkdir -p .helm-verify

          for chart in hub-agent member-agent; do
            helm pull "oci://${{ needs.export-registry.outputs.registry_repo }}/charts/${chart}" --version "${CHART_VERSION}" --destination .helm-verify >/dev/null
            packaged=".helm-verify/${chart}-${CHART_VERSION}.tgz"
            actual_app_version=$(tar -xOf "${packaged}" "${chart}/Chart.yaml" | awk -F': ' '/^appVersion:/ {gsub(/"/, "", $2); print $2}')
            if [[ "${actual_app_version}" != "${EXPECTED_APP_VERSION}" ]]; then
              echo "ERROR: ${chart} appVersion (${actual_app_version}) does not match release tag (${EXPECTED_APP_VERSION})"
              exit 1
            fi
            echo "âœ… ${chart} appVersion=${actual_app_version} matches release tag=${EXPECTED_APP_VERSION}"
          done

          rm -rf .helm-verify
